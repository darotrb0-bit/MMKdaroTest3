<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ប្រព័ន្ធសម្គាល់ផ្ទៃមុខ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=Koulen&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Fira Code', monospace;
            background-color: #0d1117;
            color: #c9d1d9;
            overflow-y: auto;
        }
        .font-khmer {
            font-family: 'Koulen', cursive;
        }
        .hacker-glow {
            text-shadow: 0 0 5px rgba(52, 211, 153, 0.7), 0 0 10px rgba(52, 211, 153, 0.5);
        }
        .hacker-border {
            border: 1px solid #34d399;
            box-shadow: 0 0 10px #34d399, inset 0 0 10px #34d399;
            transition: all 0.5s ease-in-out;
        }
        input[type="file"]::file-selector-button {
            background-color: #10b981;
            color: #0d1117;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #34d399;
            box-shadow: 0 0 15px #34d399;
        }
        
        .target-panel {
            transition: transform 0.7s ease-in-out, opacity 0.7s ease-in-out;
        }
        .target-panel.shrunk {
            transform: scale(0.9);
            opacity: 0.7;
        }
        
        .result-card {
            opacity: 0;
            transform: scale(0.8) translateY(20px);
            animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes pop-in {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .typing-effect::after {
            content: '█';
            animation: blink 0.7s infinite;
            color: #34d399;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }
        
        #mainGrid {
            transition: grid-template-columns 0.7s ease-in-out;
        }

        @media (min-width: 768px) {
            #mainGrid.results-visible {
                grid-template-columns: 0.5fr 1.5fr;
            }
        }
        
        /* --- Scan Beam Animation --- */
        .scan-beam {
            position: absolute;
            opacity: 0;
            transform-origin: left center;
            animation: shoot-beam 0.7s ease-out forwards;
        }
        .scan-beam > div {
            position: absolute;
            height: 2px;
            background: #34d399;
            box-shadow: 0 0 8px 1px #34d399;
        }
        @keyframes shoot-beam {
            0% { opacity: 1; transform: scaleX(0); }
            40% { transform: scaleX(1); }
            100% { opacity: 0; transform: scaleX(1); }
        }

        /* --- Tooltip for face selection --- */
        #face-tooltip {
            position: fixed;
            background-color: rgba(0, 0, 0, 0.8);
            color: #34d399;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.2s;
        }

        /* --- Deep Scan Animation --- */
        #deep-scan-overlay {
            position: absolute;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #deep-scan-overlay.active {
            opacity: 1;
        }
        .scan-grid {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(to right, rgba(52, 211, 153, 0.5) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(52, 211, 153, 0.5) 1px, transparent 1px);
            background-size: 20px 20px;
            animation: scan-grid-animation 2s linear infinite;
        }
        .scan-grid-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 2px;
            background: #34d399;
            box-shadow: 0 0 10px #34d399;
            animation: deep-scan-line-animation 1.5s ease-out forwards;
        }
        @keyframes scan-grid-animation {
            0% { background-position: 0 0; }
            100% { background-position: -20px -20px; }
        }
        @keyframes deep-scan-line-animation {
            0% { top: 0; opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        
        /* AI Assistant Log */
        #ai-assistant-log {
            background-color: #00000080;
            border: 1px solid #34d39960;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            height: 100px;
            overflow-y: auto;
        }
        #ai-assistant-log p {
            margin: 0;
            line-height: 1.5;
        }
        #ai-assistant-log .log-entry {
            color: #34d399;
        }
         #ai-assistant-log .log-entry.warn {
            color: #facc15;
        }

    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-5xl mx-auto relative">
        <header class="text-center mb-6">
            <h1 class="text-2xl md:text-4xl font-bold text-emerald-400 hacker-glow font-khmer">ប្រព័ន្ធសម្គាល់ផ្ទៃមុខ</h1>
            <p class="text-sm text-gray-400 mt-2">បញ្ចូលរូបភាពដើម្បីកំណត់អត្តសញ្ញាណបុគ្គលពីក្នុងមូលដ្ឋានទិន្នន័យ។</p>
        </header>

        <main id="mainGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div id="targetPanel" class="bg-gray-900/50 p-4 rounded-lg hacker-border relative overflow-hidden target-panel">
                <h2 class="text-lg font-semibold text-emerald-400 mb-4 border-b border-emerald-500/30 pb-2 font-khmer">រូបភាពគោលដៅ</h2>
                <div id="imageContainer" class="relative min-h-[250px] flex items-center justify-center bg-black rounded-md">
                    <canvas id="canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
                    <div id="uploadPrompt" class="text-center text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <p class="mt-2">រង់ចាំរូបភាព...</p>
                    </div>
                    <img id="image" class="hidden max-w-full max-h-[400px] rounded-md" />
                    <div id="deep-scan-overlay"><div class="scan-grid"></div><div class="scan-grid-line"></div></div>
                </div>
                <div class="mt-4">
                    <input type="file" id="fileInput" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold">
                </div>
            </div>

            <div class="bg-gray-900/50 p-4 rounded-lg hacker-border flex flex-col">
                <h2 class="text-lg font-semibold text-emerald-400 mb-4 border-b border-emerald-500/30 pb-2 font-khmer">AI វិភាគ & លទ្ធផល</h2>
                 <!-- NEW AI Assistant Log -->
                <div id="ai-assistant-log">
                    <p class="text-gray-500">AI Assistant: រង់ចាំបញ្ជា...</p>
                </div>
                <div id="results" class="flex-grow space-y-4 max-h-[340px] overflow-y-auto pr-2">
                     <p class="text-gray-500">លទ្ធផលនឹងបង្ហាញនៅទីនេះ។</p>
                </div>
                <div class="mt-4 pt-4 border-t border-emerald-500/30">
                    <button id="newScanButton" class="hidden w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded transition-all duration-300 hacker-glow font-khmer">
                        ចាប់ផ្តើមវិភាគសាជាថ្មី
                    </button>
                </div>
            </div>
        </main>
        <div id="animation-container" class="absolute top-0 left-0 w-full h-full pointer-events-none z-10"></div>
        <div id="face-tooltip">ចុចដើម្បីវិភាគ</div>
    </div>

    <div id="loading" class="fixed inset-0 bg-black/90 flex flex-col items-center justify-center z-50 transition-opacity duration-500">
        <div class="loader animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-emerald-500"></div>
        <p id="loadingText" class="text-emerald-400 mt-4 text-lg hacker-glow">កំពុងរៀបចំប្រព័ន្ធ...</p>
        <div class="w-64 mt-2 bg-gray-700 rounded-full h-2.5">
            <div id="progressBar" class="bg-emerald-500 h-2.5 rounded-full" style="width: 0%"></div>
        </div>
        <p id="progressText" class="text-gray-400 text-sm mt-1"></p>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const imageContainer = document.getElementById('imageContainer');
        const imgElement = document.getElementById('image');
        const canvas = document.getElementById('canvas');
        const resultsDiv = document.getElementById('results');
        const uploadPrompt = document.getElementById('uploadPrompt');
        const loadingDiv = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const targetPanel = document.getElementById('targetPanel');
        const mainGrid = document.getElementById('mainGrid');
        const newScanButton = document.getElementById('newScanButton');
        const faceTooltip = document.getElementById('face-tooltip');
        const deepScanOverlay = document.getElementById('deep-scan-overlay');
        const aiLog = document.getElementById('ai-assistant-log');
        
        // IMPORTANT: Replace 'YOUR_API_KEY' with your actual Google Cloud API Key
        const GOOGLE_API_KEY = 'AIzaSyBValEJuosFLeyoIELmb_XcXJoxUzSm3-c'; 
        const SHEET_ID = '1eRyPoifzyvB4oBmruNyXcoKMKPRqjk6xDD6-bPNW6pc';
        const RANGES = ['DIList!E9:E', 'DIList!L9:L', 'DIList!M9:M', 'DIList!N9:N', 'DIList!AA9:AA'];

        let labeledFaceDescriptors;
        let audioCtx;
        let interactiveDetections = [];
        let hoveredFaceIndex = -1;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function logToAIAssistant(message, type = 'log') {
            const newLog = document.createElement('p');
            const prefix = document.createElement('span');
            prefix.textContent = `> `;
            const text = document.createElement('span');
            
            newLog.appendChild(prefix);
            newLog.appendChild(text);

            if (type === 'warn') {
                 newLog.className = 'log-entry warn';
            } else {
                 newLog.className = 'log-entry';
            }

            aiLog.innerHTML = ''; // Clear previous logs
            aiLog.appendChild(newLog);
            typeWriter(text, message, 20);
        }
        
        function playSound(type, ...args) {
            if (!audioCtx) return;
            if (type === 'dataTransfer') {
                const noise = audioCtx.createBufferSource();
                const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.5, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < data.length; i++) { data[i] = Math.random() * 2 - 1; }
                noise.buffer = buffer;
                
                const bandpass = audioCtx.createBiquadFilter();
                bandpass.type = 'bandpass';
                bandpass.frequency.value = 1000;
                bandpass.Q.value = 20;

                const gain = audioCtx.createGain();
                gain.gain.setValueAtTime(0.001, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.4);

                bandpass.frequency.setValueAtTime(500, audioCtx.currentTime);
                bandpass.frequency.exponentialRampToValueAtTime(3000, audioCtx.currentTime + 0.4);

                noise.connect(bandpass).connect(gain).connect(audioCtx.destination);
                noise.start();
                noise.stop(audioCtx.currentTime + 0.5);

            } else if (type === 'deepScan') {
                const oscillator = audioCtx.createOscillator();
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(80, audioCtx.currentTime + 1.4);

                const gainNode = audioCtx.createGain();
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.4);
                
                oscillator.connect(gainNode).connect(audioCtx.destination);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 1.5);
            }
             else {
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                 if (type === 'beep') {
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1);
                } else if (type === 'scan') {
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(100, audioCtx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1);
                }
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.1);
            }
        }

        function typeWriter(element, text, speed = 25) {
            let i = 0;
            element.innerHTML = '';
            element.classList.add('typing-effect');
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                } else {
                    element.classList.remove('typing-effect');
                }
            }
            type();
        }

        async function loadModels() {
            loadingText.textContent = 'កំពុងទាញយកម៉ូឌែល AI...';
            progressBar.style.width = '10%';
            const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
            await Promise.all([
                faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                faceapi.nets.ageGenderNet.loadFromUri(MODEL_URL)
            ]);
        }
        
        async function fetchDataFromGoogleSheet() {
            loadingText.textContent = 'កំពុងភ្ជាប់ទៅមូលដ្ឋានទិន្នន័យ...';
            progressBar.style.width = '20%';
            
            if (GOOGLE_API_KEY === 'YOUR_API_KEY' || !GOOGLE_API_KEY) {
                const errorMsg = 'Error: GOOGLE API KEY មិន​ត្រូវ​បាន​កំណត់​ค่า​ទេ។ សូម​ដាក់​ API Key របស់​អ្នក​នៅ​ក្នុង​កូដ។';
                loadingText.textContent = errorMsg;
                setTimeout(() => {
                    loadingDiv.style.opacity = '0';
                    loadingDiv.style.pointerEvents = 'none';
                    logToAIAssistant(errorMsg, 'warn');
                }, 1500);
                return [];
            }
            
            const rangesQuery = RANGES.map(r => `ranges=${encodeURIComponent(r)}`).join('&');
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values:batchGet?${rangesQuery}&key=${GOOGLE_API_KEY}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Google Sheets API Error: ${response.statusText} (Status: ${response.status})`);
                const data = await response.json();
                loadingText.textContent = 'កំពុងដំណើរការទិន្នន័យ...';
                progressBar.style.width = '30%';
                const [ids, namesKm, names, genders, imageUrls] = data.valueRanges.map(range => range.values || []);
                const maxRows = Math.max(...(data.valueRanges.map(range => range.values ? range.values.length : 0)));
                const database = [];
                for (let i = 0; i < maxRows; i++) {
                    if (ids[i]?.[0] && imageUrls[i]?.[0]) {
                        database.push({
                            id: ids[i]?.[0] || '', nameKm: namesKm[i]?.[0] || '', name: names[i]?.[0] || 'N/A',
                            gender: genders[i]?.[0] || '', imageUrl: imageUrls[i]?.[0]
                        });
                    }
                }
                return database;
            } catch (error) {
                console.error("Failed to fetch data from Google Sheet:", error);
                const errorMsg = 'Error: មិនអាចភ្ជាប់ទៅមូលដ្ឋានទិន្នន័យបានទេ។';
                loadingText.textContent = errorMsg;
                setTimeout(() => {
                    loadingDiv.style.opacity = '0';
                    loadingDiv.style.pointerEvents = 'none';
                    logToAIAssistant(`${errorMsg} សូមពិនិត្យ API Key, Sheet ID, និងការអនុញ្ញាត (Permissions) របស់ Sheet។`, 'warn');
                }, 1500);
                return [];
            }
        }

        async function buildFaceDatabase() {
            const database = await fetchDataFromGoogleSheet();
            if (database.length === 0) {
                if (!loadingText.textContent.startsWith('Error')) loadingText.textContent = 'Error: មូលដ្ឋានទិន្នន័យទទេ ឬមិនត្រឹមត្រូវ។';
                return [];
            }
            loadingText.textContent = 'កំពុងបង្កើតសន្ទស្សន៍មុខ...';
            let processedCount = 0;
            const totalCount = database.length;
            const descriptors = await Promise.all(database.map(async (person) => {
                try {
                    const imageUrl = `https://corsproxy.io/?${encodeURIComponent(person.imageUrl)}`;
                    const img = await faceapi.fetchImage(imageUrl);
                    const detection = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                    processedCount++;
                    const progress = 30 + (processedCount / totalCount) * 60;
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `(${processedCount}/${totalCount}) Analyzing ${person.name}`;
                    if (detection) return new faceapi.LabeledFaceDescriptors(JSON.stringify(person), [detection.descriptor]);
                    return null;
                } catch (error) {
                    console.error(`Could not process image for ${person.name}:`, error);
                    processedCount++;
                    const progress = 30 + (processedCount / totalCount) * 60;
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `(${processedCount}/${totalCount}) ${person.name} (Image Error)`;
                    return null;
                }
            }));
            return descriptors.filter(d => d !== null);
        }

        async function initialize() {
            await loadModels();
            labeledFaceDescriptors = await buildFaceDatabase();
            if (!labeledFaceDescriptors || labeledFaceDescriptors.length === 0) {
                 if (!loadingText.textContent.startsWith('Error')) loadingText.textContent = 'Error: មិនអាចបង្កើតមូលដ្ឋានទិន្នន័យផ្ទៃមុខបានទេ។';
                 return;
            }
            progressBar.style.width = '100%';
            loadingText.textContent = 'ប្រព័ន្ធរួចរាល់។';
            setTimeout(() => {
                loadingDiv.style.opacity = '0';
                loadingDiv.style.pointerEvents = 'none';
            }, 1000);
        }
        
        newScanButton.addEventListener('click', () => {
            fileInput.value = '';
            fileInput.click()
        });
        
        function cleanupInteractiveListeners() {
            canvas.removeEventListener('mousemove', handleCanvasMouseMove);
            canvas.removeEventListener('click', handleCanvasClick);
            canvas.removeEventListener('mouseout', handleCanvasMouseOut);
            canvas.style.cursor = 'default';
            faceTooltip.style.opacity = '0';
            interactiveDetections = [];
            hoveredFaceIndex = -1;
        }

        async function enhanceImage(imageEl, box) {
            const tempCanvas = document.createElement('canvas');
            const scale = imageEl.naturalWidth / imageEl.width;
            const sx = box.x * scale;
            const sy = box.y * scale;
            const sw = box.width * scale;
            const sh = box.height * scale;
            tempCanvas.width = sw;
            tempCanvas.height = sh;
            const ctx = tempCanvas.getContext('2d');
            ctx.filter = 'contrast(1.3) brightness(1.1) saturate(1.2) sharpen(0.5)';
            ctx.drawImage(imageEl, sx, sy, sw, sh, 0, 0, sw, sh);
            return tempCanvas;
        }

        fileInput.addEventListener('change', async () => {
            initAudio();
            if (fileInput.files.length === 0) return;
            if (!labeledFaceDescriptors || labeledFaceDescriptors.length === 0) {
                logToAIAssistant('មូលដ្ឋានទិន្នន័យមិនទាន់រួចរាល់ទេ។ សូមពិនិត្យ API Key។', 'warn');
                return;
            }

            cleanupInteractiveListeners();
            newScanButton.classList.add('hidden');
            targetPanel.classList.remove('shrunk');
            mainGrid.classList.remove('results-visible');
            resultsDiv.innerHTML = '<p class="text-gray-500">លទ្ធផលនឹងបង្ហាញនៅទីនេះ។</p>';
            aiLog.innerHTML = '<p class="text-gray-500">AI Assistant: រង់ចាំបញ្ជា...</p>';
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const file = fileInput.files[0];
            const imageUrl = URL.createObjectURL(file);
            uploadPrompt.classList.add('hidden');
            imgElement.src = imageUrl;
            imgElement.classList.remove('hidden');
            
            imgElement.onload = async () => {
                const displaySize = { width: imgElement.width, height: imgElement.height };
                faceapi.matchDimensions(canvas, displaySize);
                logToAIAssistant('កំពុងស្វែងរកផ្ទៃមុខក្នុងរូបភាព...');
                const detections = await faceapi.detectAllFaces(imgElement, new faceapi.SsdMobilenetv1Options()).withFaceLandmarks().withFaceDescriptors().withAgeAndGender();
                const resizedDetections = faceapi.resizeResults(detections, displaySize);

                if (resizedDetections.length === 0) {
                    logToAIAssistant('រកមិនឃើញផ្ទៃមុខទេ។ សូមព្យាយាមម្តងទៀត។', 'warn');
                } else if (resizedDetections.length === 1) {
                    await analyzeSelectedFace(resizedDetections[0]);
                } else {
                    enableInteractiveFaceSelection(resizedDetections);
                }
                newScanButton.classList.remove('hidden');
            };
        });

        const handleCanvasMouseMove = (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            let foundFace = false;
            let newHoveredIndex = -1;

            interactiveDetections.forEach((detection, index) => {
                const box = detection.detection.box;
                if (x > box.x && x < box.x + box.width && y > box.y && y < box.y + box.height) {
                    foundFace = true;
                    newHoveredIndex = index;
                }
            });

            if (hoveredFaceIndex !== newHoveredIndex) {
                hoveredFaceIndex = newHoveredIndex;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                interactiveDetections.forEach((detection, index) => {
                    const boxColor = index === hoveredFaceIndex ? '#34d399' : '#ffffff';
                    new faceapi.draw.DrawBox(detection.detection.box, { boxColor, lineWidth: 2, label: `មុខ #${index+1}`}).draw(canvas);
                });
            }

            if (foundFace) {
                canvas.style.cursor = 'pointer';
                faceTooltip.style.opacity = '1';
                faceTooltip.style.left = `${e.clientX + 15}px`;
                faceTooltip.style.top = `${e.clientY}px`;
            } else {
                canvas.style.cursor = 'default';
                faceTooltip.style.opacity = '0';
            }
        };

        const handleCanvasMouseOut = () => { faceTooltip.style.opacity = '0'; };
        const handleCanvasClick = (e) => { if (hoveredFaceIndex !== -1) { analyzeSelectedFace(interactiveDetections[hoveredFaceIndex]); }};

        function enableInteractiveFaceSelection(detections) {
            logToAIAssistant(`រកឃើញ ${detections.length} ផ្ទៃមុខ។ សូមចុចលើផ្ទៃមុខណាមួយដើម្បីវិភាគ។`);
            resultsDiv.innerHTML = '';
            interactiveDetections = detections;
            hoveredFaceIndex = -1;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            detections.forEach((detection, index) => {
                new faceapi.draw.DrawBox(detection.detection.box, { boxColor: '#ffffff', lineWidth: 2, label: `មុខ #${index+1}`}).draw(canvas);
            });

            canvas.addEventListener('mousemove', handleCanvasMouseMove);
            canvas.addEventListener('click', handleCanvasClick);
            canvas.addEventListener('mouseout', handleCanvasMouseOut);
        }
        
        function triggerScanAnimation() {
            playSound('dataTransfer');
            const container = document.getElementById('animation-container');
            const startEl = document.getElementById('targetPanel');
            const endEl = document.getElementById('results');

            if (!startEl || !endEl || !container) return;

            const startRect = startEl.getBoundingClientRect();
            const endRect = endEl.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();

            const startX = startRect.right - containerRect.left;
            const startY = startRect.top + startRect.height / 2 - containerRect.top;
            const endX = endRect.left - containerRect.left;

            const beam = document.createElement('div');
            beam.className = 'scan-beam';
            const beamWidth = endX - startX;

            for(let i=0; i<3; i++) {
                const line = document.createElement('div');
                line.style.width = '100%';
                line.style.animationDelay = `${i * 0.05}s`;
                line.style.opacity = `${1 - i * 0.2}`;
                line.style.top = `${i * 4 - 4}px`;
                beam.appendChild(line);
            }

            beam.style.top = `${startY}px`;
            beam.style.left = `${startX}px`;
            beam.style.width = `${beamWidth}px`;
            container.appendChild(beam);
            setTimeout(() => beam.remove(), 700);
        }

        async function analyzeSelectedFace(detection) {
            cleanupInteractiveListeners();
            resultsDiv.innerHTML = '';
            
            let analysisMode = 'Fast Scan';
            let finalDescriptor;

            const { landmarks } = detection;
            const jawline = landmarks.getJawOutline();
            const faceWidth = jawline[16].x - jawline[0].x;
            const noseTip = landmarks.getNose()[3];
            const isProfile = Math.abs(noseTip.x - (jawline[0].x + faceWidth/2)) > faceWidth * 0.2;

            if (isProfile) {
                analysisMode = 'Profile Reconstruction';
                logToAIAssistant('រកឃើញផ្ទៃមុខបែរចំហៀង។ កំពុងព្យាយាមបង្កើតទម្រង់មុខឡើងវិញ...', 'warn');
                finalDescriptor = detection.descriptor;
            } else {
                analysisMode = 'Deep Scan';
                logToAIAssistant('គុណភាពរូបភាពល្អ។ កំពុងដំណើរការ Deep Scan...');
                const enhancedFaceCanvas = await enhanceImage(imgElement, detection.detection.box);
                const deepScanDetection = await faceapi.detectSingleFace(enhancedFaceCanvas).withFaceLandmarks().withFaceDescriptor();
                if (deepScanDetection) {
                    finalDescriptor = deepScanDetection.descriptor;
                } else {
                    logToAIAssistant('Deep Scan បរាជ័យ, ត្រឡប់មកប្រើ Standard Scan', 'warn');
                    analysisMode = 'Fast Scan';
                    finalDescriptor = detection.descriptor;
                }
            }

            if (!finalDescriptor) {
                 logToAIAssistant('ការវិភាគបរាជ័យ: មិនអាចបង្កើត Biometric Profile បានទេ។', 'warn');
                 return;
            }

            targetPanel.classList.add('shrunk');
            mainGrid.classList.add('results-visible');
            triggerScanAnimation();
            
            const { box } = detection.detection;
            if (analysisMode !== 'Fast Scan' && !isProfile) {
                deepScanOverlay.style.left = `${box.left}px`;
                deepScanOverlay.style.top = `${box.top}px`;
                deepScanOverlay.style.width = `${box.width}px`;
                deepScanOverlay.style.height = `${box.height}px`;
                deepScanOverlay.classList.add('active');
                playSound('deepScan');
                await new Promise(res => setTimeout(res, 1500));
                deepScanOverlay.classList.remove('active');
            } else {
                 await new Promise(res => setTimeout(res, 500));
            }
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const matcherThreshold = isProfile ? 0.6 : 0.5;
            const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, matcherThreshold);
            const bestMatch = faceMatcher.findBestMatch(finalDescriptor);
            const label = bestMatch.label === 'unknown' ? 'មិនស្គាល់' : JSON.parse(bestMatch.label).name;

            new faceapi.draw.DrawBox(box, { label }).draw(canvas);
            new faceapi.draw.DrawFaceLandmarks(landmarks, { drawLines: true, color: '#34d399' }).draw(canvas);

            const allMatches = labeledFaceDescriptors.map(ld => {
                const distance = faceapi.euclideanDistance(finalDescriptor, ld.descriptors[0]);
                return { distance, labelData: JSON.parse(ld.label) };
            }).sort((a, b) => a.distance - b.distance);
            
            await displayFaceResults(allMatches.slice(0, 4), analysisMode);
        }

        async function animateVerification(card) {
            const verificationContainer = card.querySelector('.verification-details');
            if (!verificationContainer) return;
            await new Promise(res => setTimeout(res, 400));
            verificationContainer.classList.remove('hidden');

            const features = verificationContainer.querySelectorAll('ul li');
            const featureNames = {
                structure: 'ទម្រង់មុខ',
                eyes: 'ទីតាំងភ្នែក',
                symmetry: 'ស៊ីមេទ្រីផ្ទៃមុខ',
                goldenRatio: 'សមាមាត្រមាស',
                texture: 'វាយនភាពស្បែក'
            };

            for (const feature of features) {
                await new Promise(res => setTimeout(res, 250));
                const featureKey = feature.dataset.feature;
                feature.querySelector('span').innerHTML = `
                    <span class="text-emerald-400 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                        ${featureNames[featureKey]}: <span class="ml-2 font-bold text-white">ផ្ទៀងផ្ទាត់រួចរាល់</span>
                    </span>
                `;
                playSound('scan');
            }
        }
        
        async function displayFaceResults(matches, analysisMode) {
            logToAIAssistant('ការវិភាគបានបញ្ចប់។ កំពុងបង្ហាញលទ្ធផល...');
            resultsDiv.innerHTML = ''; 
            const faceResultContainer = document.createElement('div');
            faceResultContainer.className = 'p-1';
            resultsDiv.appendChild(faceResultContainer);

            for (const [index, match] of matches.entries()) {
                const { distance, labelData } = match;
                const confidence = Math.max(0, (1 - distance) * 100).toFixed(2);
                
                let cardClasses = 'bg-black/50 p-3 rounded-lg border border-emerald-500/30 flex items-start space-x-4 mb-2 relative overflow-hidden result-card';
                let nameBlock = '<p class="data-name text-lg font-bold text-white"></p>';
                let verificationSection = '';
                
                if (index === 0) {
                    cardClasses = 'bg-black/50 p-3 rounded-lg border-2 border-emerald-400 flex items-start space-x-4 mb-2 relative overflow-hidden result-card';
                    nameBlock = `
                        <div class="flex items-center gap-2">
                            <p class="data-name text-lg font-bold text-white"></p>
                            <span class="text-xs bg-emerald-500 text-black font-bold py-0.5 px-1.5 rounded font-khmer">ផ្គូផ្គងល្អបំផុត</span>
                        </div>
                    `;
                    verificationSection = `
                        <div class="verification-details mt-3 pt-3 border-t border-emerald-500/30 hidden">
                            <h4 class="text-sm font-bold text-emerald-300 mb-2 font-khmer">ការវិភាគ Biometric កម្រិតខ្ពស់</h4>
                            <ul class="text-xs space-y-1">
                                <li data-feature="structure"><span>កំពុងវិភាគ ទម្រង់មុខ...</span></li>
                                <li data-feature="eyes"><span>កំពុងវិភាគ ទីតាំងភ្នែក...</span></li>
                                <li data-feature="symmetry"><span>កំពុងវិភាគ ស៊ីមេទ្រីផ្ទៃមុខ...</span></li>
                                <li data-feature="goldenRatio"><span>កំពុងវិភាគ សមាមាត្រមាស...</span></li>
                                <li data-feature="texture"><span>កំពុងវិភាគ វាយនភាពស្បែក...</span></li>
                            </ul>
                        </div>
                    `;
                }
                
                const resultCard = document.createElement('div');
                resultCard.className = cardClasses;
                
                 const analysisModeText = `<p class="text-xs text-cyan-400 mt-1">របៀបវិភាគ: ${analysisMode}</p>`;

                const cardContent = `
                    <div class="relative w-20 h-24 flex-shrink-0">
                        <img src="${labelData.imageUrl}" class="w-full h-full object-cover rounded-md border-2 border-emerald-600" alt="Matched Photo" onerror="this.src='https://placehold.co/80x96/000000/34d399?text=Error'">
                    </div>
                    <div class="flex-grow">
                        ${nameBlock}
                        <p class="data-name-km text-md text-gray-300"></p>
                        <p class="data-id text-sm text-gray-400"></p>
                        <p class="data-gender text-sm text-gray-400"></p>
                        <p class="data-distance text-sm text-gray-400"></p>
                        <div class="mt-2">
                            <span class="data-confidence font-semibold ${confidence > 50 ? 'text-emerald-400' : 'text-yellow-400'}"></span>
                        </div>
                        ${analysisModeText}
                        ${verificationSection}
                    </div>
                `;
                resultCard.innerHTML = cardContent;
                faceResultContainer.appendChild(resultCard);
                playSound(index === 0 ? 'beep' : 'scan');

                typeWriter(resultCard.querySelector('.data-name'), labelData.name);
                await new Promise(res => setTimeout(res, 100));
                typeWriter(resultCard.querySelector('.data-name-km'), labelData.nameKm);
                await new Promise(res => setTimeout(res, 100));
                typeWriter(resultCard.querySelector('.data-id'), `អត្តលេខ: ${labelData.id}`);
                await new Promise(res => setTimeout(res, 100));
                typeWriter(resultCard.querySelector('.data-gender'), `ភេទ: ${labelData.gender}`);
                await new Promise(res => setTimeout(res, 100));
                typeWriter(resultCard.querySelector('.data-distance'), `ពិន្ទុគម្លាត: ${distance.toFixed(4)}`);
                await new Promise(res => setTimeout(res, 100));
                typeWriter(resultCard.querySelector('.data-confidence'), `ទំនុកចិត្ត: ${confidence}%`);

                if (index === 0) {
                    await animateVerification(resultCard);
                }

                await new Promise(res => setTimeout(res, 400));
            }
        }
        initialize();
    </script>
</body>
</html>

